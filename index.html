<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    
    <title>Penjadwal Tugas & Pengingat Deadline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .completed { text-decoration: line-through; color: #9ca3af; }
        .deadline-warning { border-left: 4px solid #f59e0b; background-color: #fef3c7; }
        .deadline-urgent { border-left: 4px solid #ef4444; background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-3xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Penjadwal Tugas Kuliah</h1>
            <p class="text-gray-600 mt-2">Pilih mata kuliah dan pertemuan, lalu atur deadline-nya!</p>
            <p class="text-gray-600 mt-2">Richard ini WM</p>
        </header>

        <!-- Form untuk menambah tugas baru -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <form id="task-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div class="col-span-1 md:col-span-2">
                    <label for="subject-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Mata Kuliah</label>
                    <select id="subject-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">-- Pilih dari daftar --</option>
                        <option value="Tugas METODOLOGI PENELITIAN">METODOLOGI PENELITIAN</option>
                        <option value="Tugas KEAMANAN BASIS DATA">KEAMANAN BASIS DATA</option>
                        <option value="Tugas FUNDAMENTAL DATA ANALYST">FUNDAMENTAL DATA ANALYST</option>
                        <option value="Tugas STATISTIKA DAN PROBABILITAS">STATISTIKA DAN PROBABILITAS</option>
                        <option value="Tugas CHARACTER BUILDING">CHARACTER BUILDING</option>
                        <option value="Tugas SISTEM INFORMASI MANAJEMEN">SISTEM INFORMASI MANAJEMEN</option>
                        <option value="Tugas BAHASA INDONESIA">BAHASA INDONESIA</option>
                        <option value="Tugas WEB PROGRAMMING II">WEB PROGRAMMING II</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-2">
                     <label for="pertemuan-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Pertemuan</label>
                     <select id="pertemuan-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                     </select>
                </div>
                <div>
                    <label for="deadline-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Deadline</label>
                    <input type="date" id="deadline-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="deadline-time" class="block text-sm font-medium text-gray-700 mb-1">Jam Deadline</label>
                    <input type="time" id="deadline-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                        Tambah Tugas
                    </button>
                </div>
            </form>
        </div>

        <!-- Daftar Tugas -->
        <div id="task-list-container">
            <h2 class="text-2xl font-bold mb-4">Daftar Tugas Aktif</h2>
            <div id="task-list" class="space-y-4"></div>
             <p id="empty-message" class="text-center text-gray-500 mt-8 hidden">Yeay! Tidak ada tugas aktif saat ini.</p>
        </div>

    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('Service Worker berhasil didaftarkan:', registration))
                    .catch(error => console.log('Pendaftaran Service Worker gagal:', error));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const taskForm = document.getElementById('task-form');
            const subjectSelect = document.getElementById('subject-select');
            const pertemuanSelect = document.getElementById('pertemuan-select');
            const deadlineDateInput = document.getElementById('deadline-date');
            const deadlineTimeInput = document.getElementById('deadline-time');
            const taskList = document.getElementById('task-list');
            const emptyMessage = document.getElementById('empty-message');
            
            const today = new Date().toISOString().split('T')[0];
            deadlineDateInput.setAttribute('min', today);

            for (let i = 1; i <= 20; i++) {
                const option = document.createElement('option');
                option.value = `Pertemuan ${i}`;
                option.textContent = `Pertemuan ${i}`;
                pertemuanSelect.appendChild(option);
            }
            pertemuanSelect.value = "Pertemuan 1";

            function requestNotificationPermission() {
                if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('Notifikasi Diaktifkan!', { body: 'Anda akan menerima pengingat deadline.', icon: '/icon-192.png' });
                        }
                    });
                }
            }
            taskForm.addEventListener('submit', requestNotificationPermission, { once: true });


            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];

            const saveTasks = () => localStorage.setItem('tasks', JSON.stringify(tasks));

            const renderTasks = () => {
                taskList.innerHTML = '';
                emptyMessage.classList.toggle('hidden', tasks.length > 0);
                
                tasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.dataset.id = task.id;
                    
                    const deadline = new Date(task.deadline);
                    const diff = deadline - new Date();
                    const is24HourWarning = diff < 24 * 60 * 60 * 1000 && diff > 0 && !task.completed;
                    const isUrgent = diff <= 0 && !task.completed;

                    let taskClasses = 'task-item bg-white p-4 rounded-xl shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4 transition-all duration-300';
                    if (is24HourWarning) taskClasses += ' deadline-warning';
                    if (isUrgent) taskClasses += ' deadline-urgent';
                    
                    taskItem.className = taskClasses;

                    const deadlineFormatted = deadline.toLocaleString('id-ID', {
                        weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    });

                    taskItem.innerHTML = `
                        <div class="flex-grow">
                            <p class="task-name font-semibold text-lg ${task.completed ? 'completed' : ''}">${task.name}</p>
                            <p class="text-sm text-gray-500">Deadline: ${deadlineFormatted}</p>
                            <p class="time-remaining text-sm font-medium mt-1"></p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <button class="toggle-complete-btn px-3 py-1 text-sm rounded-full ${task.completed ? 'bg-gray-200 text-gray-700' : 'bg-green-100 text-green-700'}">
                                ${task.completed ? 'Batal' : 'Selesai'}
                            </button>
                            <button class="delete-btn px-3 py-1 text-sm bg-red-100 text-red-700 rounded-full">Hapus</button>
                        </div>
                    `;
                    taskList.appendChild(taskItem);
                });
                updateAllRemainingTimes();
            };
            
            const updateRemainingTime = (taskItem) => {
                const task = tasks.find(t => t.id == taskItem.dataset.id);
                if (!task) return;

                const timeRemainingEl = taskItem.querySelector('.time-remaining');
                const diff = new Date(task.deadline) - new Date();

                if (task.completed) {
                    timeRemainingEl.textContent = 'Tugas sudah selesai!';
                    timeRemainingEl.className = 'time-remaining text-sm font-medium mt-1 text-green-600';
                    return;
                }

                if (diff <= 0) {
                    timeRemainingEl.textContent = 'Waktu habis!';
                    timeRemainingEl.className = 'time-remaining text-sm font-medium mt-1 text-red-600';
                    return;
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
                const minutes = Math.floor((diff / 1000 / 60) % 60);
                const seconds = Math.floor((diff / 1000) % 60);

                timeRemainingEl.textContent = `Sisa waktu: ${days}h, ${hours}j, ${minutes}m, ${seconds}d`;
                timeRemainingEl.className = `time-remaining text-sm font-medium mt-1 ${diff < 24 * 60 * 60 * 1000 ? 'text-amber-600' : 'text-blue-600'}`;
            };
            
            const updateAllRemainingTimes = () => document.querySelectorAll('.task-item').forEach(updateRemainingTime);

            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const taskName = `${subjectSelect.value} - ${pertemuanSelect.value}`;
                const deadline = new Date(`${deadlineDateInput.value}T${deadlineTimeInput.value}`);

                if (deadline < new Date()) {
                    alert("Waktu deadline tidak boleh di masa lalu.");
                    return;
                }

                tasks.push({ id: Date.now(), name: taskName, deadline: deadline.toISOString(), completed: false, notified24h: false });
                saveTasks();
                renderTasks();
                taskForm.reset();
                pertemuanSelect.value = "Pertemuan 1";
                deadlineDateInput.setAttribute('min', today);
            });

            taskList.addEventListener('click', (e) => {
                const taskItem = e.target.closest('.task-item');
                if (!taskItem) return;
                const taskId = Number(taskItem.dataset.id);
                
                if (e.target.matches('.delete-btn')) {
                    tasks = tasks.filter(task => task.id !== taskId);
                }
                
                if (e.target.matches('.toggle-complete-btn')) {
                    const task = tasks.find(task => task.id === taskId);
                    if (task) task.completed = !task.completed;
                }
                
                saveTasks();
                renderTasks();
            });

            const checkAndNotify = () => {
                let taskUpdated = false;
                tasks.forEach(task => {
                    if (task.completed || task.notified24h) return;

                    const diff = new Date(task.deadline) - new Date();
                    
                    if (diff < 24 * 60 * 60 * 1000 && diff > 0) {
                        if (Notification.permission === 'granted') {
                            navigator.serviceWorker.ready.then(registration => {
                                registration.showNotification('Tugas Segera Deadline!', {
                                    body: `Tugas "${task.name}" akan berakhir dalam kurang dari 24 jam.`,
                                    icon: 'icon-192.png',
                                    badge: 'icon-72.png',
                                    // *** BARU ***: Tag untuk mencegah notif duplikat
                                    tag: `task-${task.id}` 
                                });
                            });
                        }
                        task.notified24h = true;
                        taskUpdated = true;
                    }
                });
                if (taskUpdated) saveTasks();
            };
            
            // *** BARU ***: Listener untuk 'visibilitychange'
            // Ini akan jalan setiap kali kamu buka lagi tab browsernya
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    console.log('Tab is visible again, checking tasks...');
                    renderTasks(); // Update tampilan
                    checkAndNotify(); // Langsung cek notifikasi
                }
            });


            setInterval(updateAllRemainingTimes, 1000);
            setInterval(checkAndNotify, 30000); 
            renderTasks();
            checkAndNotify(); // Cek juga saat pertama kali halaman dimuat
        });
    </script>
</body>
</html>

